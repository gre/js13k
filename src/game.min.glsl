#ifdef GL_ES
precision mediump float;
#endif
#define BPM_MIN 30.0
#define BPM_MAX 150.0
uniform vec2 resolution;uniform float time;uniform float kick;uniform float kickSpeed;uniform float bpm;uniform float lvl;uniform float useraction;uniform float successState;uniform float dubloading;uniform float pulseOpenFrom;uniform float pulseOpenTo;uniform bool dubstepAction;uniform bool dubphase;const vec2 a=vec2(.5);const float b=3.14159265359;const float c=6.28318530718;const vec3 d=vec3(.1,.2,.7);const vec3 e=vec3(0,.7,.1);const vec3 f=vec3(.7,0,.05);float F(vec2 g){return fract(sin(dot(g.xy,vec2(12.9898,78.233)))*43758.5453);}float G(float g,float h){float i=mod(distance(g,h),c);return i<b?i:c-i;}float H(vec2 g,float h){float i,j,k;i=length(g);j=(b+atan(g.x,g.y))/c;k=log(i/h)+j;return distance(1.,2.*smoothstep(0.,1.,fract(k)));}float I(float g){return 60./g;}float J(vec2 g,float h,float i,float j,float k,float l,bool m,float n,float o,float p,float q){float r,s,t,u,v,w,x,y,z,A,B,C;r=atan(-g.x,-g.y);s=G(0.,r)/b;t=G(r,c*l)/b;u=mix(1.,smoothstep(-1.,1.,cos(i*(s+.1*r+h))),j);v=mix(.35,.2,h*u);w=smoothstep(1.-p,1.,t);x=.1+.05*w;v/=mix(.95,1.,o*w*cos(r*n));y=mod(c+atan(g.x,g.y),c)/c;z=abs(length(g)-v)-.03*q*(!m?smoothstep(1.-1.5*p,1.,s):y<pulseOpenFrom?smoothstep(.05,0.,distance(y,pulseOpenFrom)):y>pulseOpenTo?smoothstep(.05,0.,distance(y,pulseOpenTo)):1.);A=smoothstep(0.,x,z);B=1./sqrt(abs(A))/1.*pow(k,2.);if(length(g)<v){float C,D,y,g;C=b;D=H(g,C);y=(b+atan(g.x,g.y))/c;;g=smoothstep(.02,0.,G(b+l*c,y*c)/b)*smoothstep(.2,0.,D);B+=g*2.;D=1.-pow(smoothstep(0.,.3,D),.3);B+=D;}C=m?.1:.1*dubloading;if(C>0.){float D,E;D=I(bpm);E=mix(1.,10.,mod(time,D)/D)*smoothstep(C,0.,length(g));B+=E;}return B;}void main(){vec3 g,m;g=vec3(0);vec2 h=gl_FragCoord.xy/resolution;float i,j,k,l,n;i=I(bpm);j=smoothstep(.8,0.,time-useraction);k=dubstepAction?1.:j;l=J(h-a,smoothstep(kickSpeed,0.,time-kick),20.,.5,.5+.5*smoothstep(smoothstep(.6,1.,j),0.,distance(smoothstep(.8,1.,j),distance(h,a))),mod((time-kick)/i,1.),dubphase,1.2*sqrt(bpm)+4.*j,2.,min(.5,bpm/8e2),1.-j);m=mix(d,mix(f,e,successState),k);g+=l*m;g=clamp(g,vec3(.05),vec3(1));n=smoothstep(BPM_MIN,BPM_MAX,bpm);g=mix(g*(.5*F(h+time)+.5*F(floor(h*1e2)+.01*time)-.5*F(floor(h*10.)+time)),g,min(1.,15.*n));g*=.1+max(.95,1e2*(n-.85));gl_FragColor=vec4(g,1);}
